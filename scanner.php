<?php
/*
Plugin Name: WordPress Malware Scanner (Enhanced)
Description: An enhanced plugin to scan, clean, or quarantine WordPress installations for malware with advanced safety measures.
Author: RiotRequest (Enhanced)
Version: 3.0
*/

if ( ! defined( 'ABSPATH' ) ) {
    exit; // Exit if accessed directly.
}

/**
 * Define a log file for malware scanner actions.
 */
if ( ! defined( 'WMS_LOG_FILE' ) ) {
    define( 'WMS_LOG_FILE', WP_CONTENT_DIR . '/malware_scanner_log.txt' );
}

/**
 * Log messages to the log file.
 *
 * @param string $message The message to log.
 */
function wms_log( $message ) {
    $time = date( 'Y-m-d H:i:s' );
    error_log( "$time: $message\n", 3, WMS_LOG_FILE );
}

/**
 * Initialize the WordPress Filesystem API.
 */
function wms_initialize_filesystem() {
    if ( ! function_exists( 'WP_Filesystem' ) ) {
        require_once ABSPATH . 'wp-admin/includes/file.php';
    }
    global $wp_filesystem;
    if ( empty( $wp_filesystem ) ) {
        WP_Filesystem();
    }
}
add_action( 'admin_init', 'wms_initialize_filesystem' );

/**
 * Add admin menu.
 */
function wms_scanner_menu() {
    add_menu_page(
        'Malware Scanner',
        'Malware Scanner',
        'manage_options',
        'malware-scanner',
        'wms_scanner_admin_page',
        'dashicons-shield',
        100
    );
}
add_action( 'admin_menu', 'wms_scanner_menu' );

/**
 * Admin page content.
 */
function wms_scanner_admin_page() {
    ?>
    <div class="wrap">
        <h1>Malware Scanner</h1>
        <p>
            This tool can scan your WordPress installation for suspicious code.
            <br><strong>Dry Run</strong> will only report potential issues.
            <br><strong>Clean Scan</strong> will back up and attempt to clean any infections.
            <br><strong>Quarantine Scan</strong> will move infected files to a quarantine folder.
        </p>
        <p>
            <em>Note: Always back up your site before performing cleaning or quarantine operations.</em>
        </p>
        <button id="dry-run-malware" class="button">Dry Run Scan</button>
        <button id="clean-malware" class="button button-primary" disabled>Clean Scan</button>
        <button id="quarantine-malware" class="button button-secondary" disabled>Quarantine Scan</button>
        <div id="scan-results" style="margin-top:20px; white-space: pre-wrap;"></div>
    </div>
    <script type="text/javascript">
        jQuery(document).ready(function($) {
            // Dry Run scan
            $('#dry-run-malware').on('click', function() {
                $('#scan-results').html('Scanning... Please wait.');
                $.post(ajaxurl, {
                    action: 'wms_scan_wordpress',
                    mode: 'dry_run'
                }, function(response) {
                    $('#scan-results').html(response);
                    // Enable cleaning and quarantine buttons if potential malware is found.
                    if (response.indexOf('Infected file found:') !== -1) {
                        $('#clean-malware, #quarantine-malware').prop('disabled', false);
                    } else {
                        $('#clean-malware, #quarantine-malware').prop('disabled', true);
                    }
                });
            });

            // Clean Scan (requires confirmation)
            $('#clean-malware').on('click', function() {
                if ( confirm('Are you sure you want to run the Clean Scan? This will back up and attempt to remove malware from infected files.') ) {
                    $('#scan-results').html('Running Clean Scan... Please wait.');
                    $.post(ajaxurl, {
                        action: 'wms_scan_wordpress',
                        mode: 'clean'
                    }, function(response) {
                        $('#scan-results').html(response);
                        $('#clean-malware, #quarantine-malware').prop('disabled', true);
                    });
                }
            });

            // Quarantine Scan (requires confirmation)
            $('#quarantine-malware').on('click', function() {
                if ( confirm('Are you sure you want to quarantine infected files? This will move them to a quarantine folder.') ) {
                    $('#scan-results').html('Running Quarantine Scan... Please wait.');
                    $.post(ajaxurl, {
                        action: 'wms_scan_wordpress',
                        mode: 'quarantine'
                    }, function(response) {
                        $('#scan-results').html(response);
                        $('#clean-malware, #quarantine-malware').prop('disabled', true);
                    });
                }
            });
        });
    </script>
    <?php
}

/**
 * AJAX handler for scanning.
 */
function wms_scan_wordpress_ajax() {
    if ( ! current_user_can( 'manage_options' ) ) {
        wp_die( 'Unauthorized user' );
    }
    $mode = isset( $_POST['mode'] ) ? sanitize_text_field( $_POST['mode'] ) : 'dry_run';
    $result = wms_scan_and_process( ABSPATH, $mode );
    echo wp_kses_post( nl2br( $result ) );
    wp_die();
}
add_action( 'wp_ajax_wms_scan_wordpress', 'wms_scan_wordpress_ajax' );

/**
 * Main scanning and processing function.
 *
 * @param string $directory The directory to scan.
 * @param string $mode 'dry_run', 'clean', or 'quarantine'.
 * @return string Report of scan results.
 */
function wms_scan_and_process( $directory, $mode = 'dry_run' ) {
    global $wp_filesystem;
    wms_initialize_filesystem();

    // Define file extensions to scan.
    $scan_extensions = array( 'php', 'phtml', 'php3', 'php4', 'php5', 'php7', 'phps', 'js', 'html', 'htm', 'htaccess' );

    // Define suspicious strings (malware signatures). Use filter to allow dynamic updates.
    $default_signatures = array(
        'base64_decode',
        'eval(',
        'gzinflate',
        'str_rot13',
        'eval_base64_decode',
        'exec_shell',
        'shell_exec',
        'popen',
        'proc_open',
        'system',
        'curl_exec',
        'curl'
    );
    $malware_signatures = apply_filters( 'wms_malware_signatures', $default_signatures );

    // Directories to exclude from scanning.
    $excluded_dirs = array(
        realpath( ABSPATH . 'wp-content/uploads' ),
        realpath( ABSPATH . 'wp-content/cache' ),
    );

    // Prepare quarantine directory if needed.
    $quarantine_dir = WP_CONTENT_DIR . '/uploads/malware-quarantine';
    if ( 'quarantine' === $mode && ! $wp_filesystem->is_dir( $quarantine_dir ) ) {
        if ( ! $wp_filesystem->mkdir( $quarantine_dir, FS_CHMOD_DIR ) ) {
            $error = "Failed to create quarantine directory at: $quarantine_dir";
            wms_log( $error );
            return $error;
        }
    }

    $infected_files = array();
    $has_malware    = false;
    $report         = '';

    // Set up Recursive Directory Iterator.
    try {
        $dir_iterator = new RecursiveDirectoryIterator( $directory, RecursiveDirectoryIterator::SKIP_DOTS );
    } catch ( Exception $e ) {
        $error = "Error accessing directory: " . esc_html( $e->getMessage() );
        wms_log( $error );
        return $error;
    }
    $iterator = new RecursiveIteratorIterator( $dir_iterator );

    foreach ( $iterator as $file_obj ) {
        $file_path = $file_obj->getPathname();

        // Skip excluded directories.
        $skip = false;
        foreach ( $excluded_dirs as $excluded ) {
            if ( strpos( realpath( $file_path ), $excluded ) === 0 ) {
                $skip = true;
                break;
            }
        }
        if ( $skip ) {
            continue;
        }

        // Process only files with allowed extensions.
        $ext = strtolower( pathinfo( $file_path, PATHINFO_EXTENSION ) );
        if ( ! in_array( $ext, $scan_extensions, true ) && ! in_array( basename( $file_path ), $scan_extensions, true ) ) {
            continue;
        }

        // Read file contents.
        $file_contents = $wp_filesystem->get_contents( $file_path );
        if ( false === $file_contents ) {
            $infected_files[] = "Could not read file: $file_path";
            wms_log( "Error reading file: $file_path" );
            continue;
        }

        $clean = true;
        // Check for each malware signature.
        foreach ( $malware_signatures as $signature ) {
            if ( stripos( $file_contents, $signature ) !== false ) {
                $clean = false;
                break;
            }
        }

        if ( ! $clean ) {
            $has_malware    = true;
            $infected_files[] = "Infected file found: $file_path";
            wms_log( "Malware detected in file: $file_path" );

            if ( 'clean' === $mode ) {
                // Clean mode: create backup and attempt cleaning.
                $backup_file = $file_path . '.' . time() . '.bak';
                if ( ! $wp_filesystem->copy( $file_path, $backup_file, true ) ) {
                    $infected_files[] = "Failed to create backup for: $file_path";
                    wms_log( "Backup failed for: $file_path" );
                    continue;
                }
                // Remove suspicious code.
                $cleaned_contents = preg_replace( "/base64_decode\s*\((.*?)\)/i", "", $file_contents );
                foreach ( $malware_signatures as $signature ) {
                    $cleaned_contents = str_ireplace( $signature, '', $cleaned_contents );
                }
                if ( false === $wp_filesystem->put_contents( $file_path, $cleaned_contents, FS_CHMOD_FILE ) ) {
                    $infected_files[] = "Failed to write cleaned contents to: $file_path";
                    wms_log( "Failed to write cleaned file: $file_path" );
                    continue;
                }
                $infected_files[] = "Cleaned malware from: $file_path (backup saved as $backup_file)";
                wms_log( "Cleaned file: $file_path (backup: $backup_file)" );
            } elseif ( 'quarantine' === $mode ) {
                // Quarantine mode: move the infected file to the quarantine directory.
                $file_basename = basename( $file_path );
                $quarantine_file = trailingslashit( $quarantine_dir ) . $file_basename . '.' . time() . '.quarantine';
                if ( ! $wp_filesystem->move( $file_path, $quarantine_file ) ) {
                    $infected_files[] = "Failed to quarantine file: $file_path";
                    wms_log( "Failed to quarantine: $file_path" );
                    continue;
                }
                $infected_files[] = "Quarantined file: $file_path (moved to $quarantine_file)";
                wms_log( "Quarantined file: $file_path to $quarantine_file" );
            }
        }
    }

    if ( ! $has_malware ) {
        $report .= "No infected files were found in the installation: " . esc_html( $directory ) . "\n";
    } else {
        $report .= "Action: " . ucfirst( $mode ) . " Scan performed.\n";
        $report .= "Details:\n";
        foreach ( $infected_files as $entry ) {
            $report .= $entry . "\n";
        }
    }

    return $report;
}
?>
