<?php

function scan_and_clean_wordpress($directory) {
    // List of common WordPress malware file types and extensions
    $malware_types = [
        "application/x-php", // PHP files
        ".php", // PHP files
        ".phtml", // PHP files
        ".php3", // PHP files
        ".php4", // PHP files
        ".php5", // PHP files
        ".php7", // PHP files
        ".phps", // PHP files
        ".js", // JavaScript files
        ".html", // HTML files
        ".htm", // HTML files
        ".htaccess" // Apache server configuration file
    ];

    // Scan the directory for malware
    $malware_found = false;
    $infected_files = [];
    $dir = new RecursiveDirectoryIterator($directory);
    $iterator = new RecursiveIteratorIterator($dir);
    foreach ($iterator as $file) {
        $file_path = $file->getPathname();
        $finfo = finfo_open(FILEINFO_MIME_TYPE);
        $mime_type = finfo_file($finfo, $file_path);
        if (in_array($mime_type, $malware_types) || in_array(strtolower(pathinfo($file_path, PATHINFO_EXTENSION)), $malware_types)) {
            $file_contents = file_get_contents($file_path);
           
            // Check for base64-encoded malware
            if (preg_match("/base64_decode\s*\(/i", $file_contents)) {
                $malware_found = true;
                $infected_files[] = $file_path;
                // Attempt to clean the file by removing the base64-encoded malware
                $file_contents = preg_replace("/base64_decode\s*\(([^)]+)\)/i", "", $file_contents);
                file_put_contents($file_path, $file_contents);
            }
        }
    }
    // If no malware was found, print a message stating that the WordPress installation is clean
    if (!$malware_found) {
        echo "No malware was found in WordPress installation: " . $directory . "\n";
    } else {
        // If malware was found, print a list of infected files that could not be cleaned
        echo "The following files could not be cleaned:\n";
        foreach ($infected_files as $infected_file) {
            echo $infected_file . "\n";
        }
    }
}

// Example usage: scan the root directory of a WordPress installation
scan_and_clean_wordpress("/path/to/wordpress/root");

?>
